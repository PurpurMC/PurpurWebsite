---
import PurpurDownloads from "../../../components/PurpurDownloads.astro";
export const prerender = false

import Base from "../../../layouts/Base.astro";

const title = 'Download - Your minecraft, your way';
const description = 'Download - Your minecraft - your way.';
const permalink = Astro.site.href;
const current = 'download';

let latestVersion = null;
const allVersions: string[] = [];

const versionRequestResult = await fetch("https://api.purpurmc.org/v2/purpur")
  .catch(() => {
    return null;
  });
if (versionRequestResult === null) {
  console.error("Failed to fetch Purpur versions");
  return Astro.redirect("/502");
}

const versions = await versionRequestResult.json().catch(() => {
  console.error("Failed to parse Purpur versions");
  return null;
});

if (versions === null || Array.isArray(versions.versions) === false) {
  console.error("Failed to parse Purpur versions");
  return Astro.redirect("/500");
}

for (const version of versions.versions) {
  allVersions.push(version);
}

latestVersion = versions?.metadata?.current ?? allVersions[allVersions.length - 1];

---
<Base title={title} description={description} permalink={permalink} current={current}>
  <div>
    <h1>Purpur</h1>
    <h2>Downloads</h2>
    <p style="text-align: center;" id="versionDisplay">{latestVersion}</p>
  </div>

  <PurpurDownloads version={latestVersion} latestVersion={latestVersion}/>
</Base>

<style lang="scss">
  h1, h2 {
    text-align: center;
  }

  .downloads {
    display: flex;
    justify-content: flex-start;
    flex-direction: column;
    align-items: start;
    min-height: 30rem;
    gap: 3rem;
  }

  .version-list {
    display: flex;
    flex-direction: column;
    width: 100%;

    &.latest {
      h3 {
        font-size: 2rem;
      }
    }
  }

  .entry {
    display: flex;
    position: relative;
    justify-content: flex-start;
    align-items: start;
    padding: 1rem;
    margin: 0.5rem;
    gap: 2rem;
    width: 100%;

    .key {
      display: flex;
      flex-direction: column;
      justify-content: start;
      align-items: center;
      min-height: 3.5rem;
      min-width: 6rem;

      .date {
        font-size: 0.7rem;
      }
    }

    &:not(:last-child) {
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    a {
      text-decoration: none;
    }

    [data-changelog] {
      display: flex;
      flex: 1;
      min-width: min(20rem, 100%);
    }

  }

  @media (max-width: 940px) {
    .entry {
      flex-wrap: wrap;
    }
  }

</style>
